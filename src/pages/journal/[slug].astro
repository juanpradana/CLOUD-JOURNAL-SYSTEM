---
import Layout from "../../layouts/Layout.astro";
import GlassCard from "../../components/GlassCard.astro";
import AdSlot from "../../components/AdSlot.astro";
import fs from "node:fs/promises";
import path from "node:path";
import { marked } from "marked";
import createDOMPurify from "dompurify";
import { parseHTML } from "linkedom";

const { window } = parseHTML("<html><body></body></html>");
const purify = createDOMPurify(window);

const { slug } = Astro.params;

if (!slug) {
    return Astro.redirect("/404");
}

const contentDir = path.join(process.cwd(), "src/content/jurnal");
let content = "";
let frontmatter = { title: "", date: "", author_username: "", cover_image: "" };
let htmlContent = "";

try {
    // Find file with slug in filename or inside file? 
    // Our design saves files as [slug].md usually, but let's be robust
    // Actually, in api/save-post we save as [slug].md
    const filePath = path.join(contentDir, `${slug}.md`);
    content = await fs.readFile(filePath, "utf-8");
    
    // Parse Frontmatter manually
    const fmEnd = content.indexOf('---', 3);
    let bodyRaw = content;
    if (content.startsWith('---') && fmEnd !== -1) {
        const fmRaw = content.substring(3, fmEnd);
        bodyRaw = content.substring(fmEnd + 3);
        
        const titleMatch = fmRaw.match(/title:\s*(.*)/);
        const dateMatch = fmRaw.match(/date:\s*(.*)/);
        const authorMatch = fmRaw.match(/author_username:\s*(.*)/);
        const coverMatch = fmRaw.match(/cover_image:\s*(.*)/);

        frontmatter = {
            title: titleMatch ? titleMatch[1].trim() : "Untitled",
            date: dateMatch ? dateMatch[1].trim() : new Date().toISOString(),
            author_username: authorMatch ? authorMatch[1].trim() : "Unknown",
            cover_image: coverMatch ? coverMatch[1].trim().replace(/^["']|["']$/g, "") : "",
        };
    }

    // Render Markdown
    htmlContent = purify.sanitize(marked.parse(bodyRaw) as string);
    
    // Add loading="lazy" to all images
    htmlContent = htmlContent.replace(/<img /g, '<img loading="lazy" ');

    // Inject AdSlot into HTML (After 2nd paragraph)
    const firstP = htmlContent.indexOf('</p>');
    if (firstP !== -1) {
        const secondP = htmlContent.indexOf('</p>', firstP + 4);
        if (secondP !== -1) {
            const adHtml = `
                <div class="w-full my-8 p-4 bg-white/5 border border-white/10 rounded-xl flex flex-col items-center justify-center text-center">
                    <span class="text-xs font-mono text-gray-500 mb-2">SPONSORED CONTENT</span>
                    <div class="text-gray-400 text-sm">Ad Space Available</div>
                </div>
            `;
            htmlContent = htmlContent.slice(0, secondP + 4) + adHtml + htmlContent.slice(secondP + 4);
        }
    }
} catch (e) {
    console.error(e);
    return Astro.redirect("/404");
}
---

<Layout title={`${frontmatter.title} - Glass Cloud Journal`}>
    <article class="min-h-screen pb-20">
        <!-- Header -->
        <header class="relative py-16 sm:py-24 md:py-32 px-4 overflow-hidden border-b border-white/10 bg-black/40">
            <!-- Dynamic Background -->
            {frontmatter.cover_image ? (
                <div class="absolute inset-0 z-[-1]">
                    <img src={frontmatter.cover_image} alt="Cover" class="w-full h-full object-cover opacity-30 blur-sm" />
                    <div class="absolute inset-0 bg-gradient-to-t from-[#020617] to-transparent"></div>
                </div>
            ) : (
                <div class="absolute inset-0 bg-blue-900/10 blur-3xl z-[-1]"></div>
            )}
            
            <div class="max-w-4xl mx-auto text-center space-y-3 sm:space-y-4 relative z-10">
                <div class="flex items-center justify-center gap-4 text-sm font-mono text-blue-400">
                    <span>{new Date(frontmatter.date).toLocaleDateString()}</span>
                    <span>â€¢</span>
                    <span>{frontmatter.author_username}</span>
                </div>
                <h1 class="text-3xl sm:text-4xl md:text-6xl font-bold text-white leading-tight drop-shadow-2xl">
                    {frontmatter.title}
                </h1>
            </div>
        </header>

        <div class="max-w-4xl mx-auto px-4 py-8 sm:py-12 grid grid-cols-1 lg:grid-cols-[1fr_300px] gap-8 sm:gap-12 min-w-0">
            <!-- Content -->
            <main class="prose prose-invert prose-sm sm:prose-base lg:prose-lg prose-blue max-w-none break-words 
                prose-headings:bg-gradient-to-r prose-headings:from-blue-400 prose-headings:to-purple-500 prose-headings:bg-clip-text prose-headings:text-transparent
                prose-p:text-gray-300/90 prose-strong:text-white prose-a:text-blue-300 hover:prose-a:text-blue-200 prose-a:no-underline hover:prose-a:underline
                prose-blockquote:border-l-blue-500/40 prose-blockquote:bg-white/5 prose-blockquote:rounded-r-xl prose-blockquote:px-4 prose-blockquote:py-2 prose-blockquote:text-gray-200
                prose-hr:border-white/10 prose-img:rounded-xl prose-img:border prose-img:border-white/10 prose-img:shadow-2xl
                prose-pre:bg-[#020617] prose-pre:border prose-pre:border-white/10 prose-pre:rounded-xl prose-pre:overflow-x-auto
                prose-code:text-purple-200 prose-code:bg-white/5 prose-code:px-1 prose-code:py-0.5 prose-code:rounded">
                <div set:html={htmlContent} />
            </main>

            <!-- Sidebar -->
            <aside class="space-y-8">
                <GlassCard>
                    <h3 class="font-bold text-white mb-4">About Author</h3>
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-white font-bold text-xl">
                            {frontmatter.author_username[0]?.toUpperCase()}
                        </div>
                        <div>
                            <p class="font-medium text-white">{frontmatter.author_username}</p>
                            <p class="text-xs text-gray-400">Journalist</p>
                        </div>
                    </div>
                </GlassCard>

                <AdSlot slotId="sidebar-ad" />

                <div class="lg:sticky lg:top-8">
                    <GlassCard className="space-y-4">
                         <h3 class="font-bold text-white mb-2">Share Entry</h3>
                         <div class="flex gap-2">
                             <button class="flex-1 py-2 bg-white/5 hover:bg-white/10 rounded text-sm text-gray-300 transition-colors">Twitter</button>
                             <button class="flex-1 py-2 bg-white/5 hover:bg-white/10 rounded text-sm text-gray-300 transition-colors">Copy Link</button>
                         </div>
                    </GlassCard>
                </div>
            </aside>
        </div>
    </article>
</Layout>
